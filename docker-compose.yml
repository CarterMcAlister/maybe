---
version: '3.9'

services:
    postgres:
        container_name: postgres
        profiles: [services]
        image: timescale/timescaledb:latest-pg14
        ports:
            - 5433:5432
        environment:
            POSTGRES_USER: maybe
            POSTGRES_PASSWORD: maybe
            POSTGRES_DB: maybe_local
        volumes:
            - postgres_data:/var/lib/postgresql/data

    redis:
        container_name: redis
        profiles: [services]
        image: redis:6.2-alpine
        ports:
            - 6379:6379
        command: 'redis-server --bind 0.0.0.0'

    ngrok:
        env_file: .env
        image: ngrok/ngrok:latest
        profiles: [ngrok]
        container_name: ngrok
        ports:
            - 4040:4040
        environment:
            NGROK_AUTHTOKEN: ${NGROK_AUTH_TOKEN}
            NGROK_REGION: us
        # command: http --log=stdout ${NGROK_DOMAIN:-host.docker.internal}:3333
        command: http --log=stdout host.docker.internal:3333 --domain=${NGROK_DOMAIN}

    server:
        env_file: .env
        container_name: maybe-server
        profiles: [maybe]
        image: ghcr.io/CarterMcAlister/maybe:main
        ports:
            - 3333
        environment:
            # NEXTAUTH_URL: &canonical https://maybe.example.com
            # NX_NEXTAUTH_URL: *canonical
            # NX_CLIENT_URL: *canonical
            # NX_CLIENT_URL_CUSTOM: *canonical
            # NEXT_PUBLIC_API_URL: &next_public_api_url https://maybe-server.example.com
            # NX_API_URL: &nx_api_url https://maybe-server.example.com
            NX_REDIS_URL: &nx_redis_url redis://redis:6379
            NODE_ENV: production
    client:
        env_file: .env
        container_name: maybe-client
        profiles: [maybe]
        image: ghcr.io/CarterMcAlister/maybe-client:main
        ports:
            - 4200
        environment:
            # NEXTAUTH_URL: *canonical
            # NX_NEXTAUTH_URL: *canonical
            # NX_CLIENT_URL: *canonical
            # NX_CLIENT_URL_CUSTOM: *canonical
            # NEXT_PUBLIC_API_URL: *next_public_api_url
            # NX_API_URL: *nx_api_url
            NX_REDIS_URL: *nx_redis_url
            NODE_ENV: production
    worker:
        env_file: .env
        container_name: maybe-worker
        profiles: [maybe]
        image: ghcr.io/CarterMcAlister/maybe-worker:main
        ports:
            - 3334
        environment:
            # NEXTAUTH_URL: *canonical
            # NX_NEXTAUTH_URL: *canonical
            # NX_CLIENT_URL: *canonical
            # NX_CLIENT_URL_CUSTOM: *canonical
            # NEXT_PUBLIC_API_URL: *next_public_api_url
            # NX_API_URL: *nx_api_url
            NX_REDIS_URL: *nx_redis_url
            NODE_ENV: production

volumes:
    postgres_data:
